# Watchdog System - 숀봇 신경계 L1 뇌간 (아드레날린)

**목표**: 안정성 3/10 → 10/10 (99.99% 가용성)  
**기간**: Week 1-3  
**신경전달물질**: 아드레날린 100% 분비

---

## 🧠 **개요**

Watchdog는 숀봇의 안정성을 극대화하는 시스템입니다. 뇌간이 신체의 기본 생명 기능을 담당하듯이, Watchdog는 봇의 프로세스를 지속적으로 모니터링하고 문제 발생 시 즉시 복구합니다.

### **핵심 기능**

1. **프로세스 모니터링** (5초 주기)
   - 프로세스 상태 지속 확인
   - 메모리, CPU, 스레드 추적
   - 좀비 프로세스 감지

2. **자동 재시작** (< 5초)
   - 프로세스 다운 감지
   - 자동 재시작 (최대 3회)
   - 지수 백오프 적용

3. **의존성 자동 복구**
   - 누락된 패키지 감지
   - 자동 설치 시도
   - 대체 모듈 사용

4. **환경 변수 자동 초기화**
   - 필수 환경 변수 확인
   - 누락 시 경고 + 대기
   - 타임아웃 관리 (5분)

5. **상세 로깅**
   - 모든 이벤트 기록
   - 일일 로그 파일
   - 실시간 콘솔 출력

---

## 📁 **파일 구조**

```
systems/bot/
├── shawn_bot_watchdog.py      # Watchdog 메인 코드
├── watchdog_config.json       # 설정 파일
├── run_watchdog.sh            # 실행 스크립트
├── README.md                  # 이 파일
└── logs/
    └── watchdog/
        └── 20260205_watchdog.log
```

---

## 🚀 **시작하기**

### **1. 의존성 설치**

```bash
cd systems/bot
python3 -m venv .venv_bot
source .venv_bot/bin/activate
pip install psutil python-telegram-bot aiohttp pillow requests pandas
```

### **2. 환경 변수 설정**

```bash
export TELEGRAM_BOT_TOKEN="your_token_here"
export OPENAI_API_KEY="your_key_here"
export GEMINI_API_KEY="your_key_here"
```

### **3. Watchdog 시작**

```bash
bash run_watchdog.sh
```

또는 직접 실행:

```bash
python3 shawn_bot_watchdog.py
```

---

## 📊 **Watchdog 동작 흐름**

```
시작
  ↓
1️⃣ 의존성 확인
   ├─ 모든 패키지 설치됨? → 다음
   └─ 누락? → 자동 설치 시도
  ↓
2️⃣ 환경 변수 확인
   ├─ 모든 변수 설정됨? → 다음
   └─ 누락? → 경고 + 대기 (최대 5분)
  ↓
3️⃣ 봇 프로세스 시작
   ├─ 시작 성공 → 다음
   └─ 실패? → 재시도 (최대 3회)
  ↓
4️⃣ 모니터링 루프 (5초 주기)
   ├─ 프로세스 정상? → 로깅 + 메트릭 수집
   └─ 다운? → 재시작 시도
  ↓
반복...
```

---

## 🔍 **모니터링 메트릭**

### **프로세스 상태**
- PID (프로세스 ID)
- 상태 (실행 중, 슬립, 좀비, 중지, 종료)
- 메모리 사용량 (MB)
- CPU 사용률 (%)
- 스레드 개수
- 열린 파일 개수

### **경고 및 임계값**
```
메모리 사용량:
- 정상: < 500MB
- 경고: 500-800MB
- 심각: > 800MB
```

---

## 📝 **로그 파일**

### **위치**
```
logs/watchdog/20260205_watchdog.log
```

### **로그 형식**
```
2026-02-05 10:00:00 [INFO] 🚀 Watchdog 시작 - 모니터링 대상: SHawn-Bot (Telegram)
2026-02-05 10:00:05 [DEBUG] 프로세스 상태 확인: ✅ 정상 (PID: 12345)
2026-02-05 10:00:10 [DEBUG] 프로세스 상태 확인: ✅ 정상 (PID: 12345)
2026-02-05 10:00:15 [DEBUG] 📊 메트릭: 메모리 245.3MB, CPU 2.1%, 스레드 8
```

---

## ⚠️ **주요 로그 메시지**

### **정상 작동**
- `✅ Watchdog 모니터링 시작 (5초 주기)`
- `✅ 모든 의존성 설치됨`
- `✅ 모든 환경 변수 설정됨`

### **경고**
- `⚠️  환경 변수 미설정: TELEGRAM_BOT_TOKEN`
- `⚠️  프로세스 다운 감지 (연속: 1회)`
- `⚠️  프로세스가 즉시 종료됨`

### **에러**
- `🔴 프로세스 다운 감지! (PID: 12345)`
- `❌ 프로세스 복구 실패`
- `❌ 타임아웃! 환경 변수 설정 안 됨`

---

## 🔧 **설정 커스터마이징**

### **watchdog_config.json**

```json
{
  "monitoring": {
    "check_interval_seconds": 5,           // 모니터링 주기
    "consecutive_down_threshold": 2        // 재시작 판단 기준
  },
  "restart": {
    "max_attempts": 3,                     // 최대 재시작 횟수
    "initial_delay_seconds": 1             // 초기 지연
  }
}
```

---

## 📈 **Week 1 목표**

### **구현 완료 ✅**
- [x] Watchdog 기본 시스템
- [x] 프로세스 모니터링 (5초 주기)
- [x] 자동 재시작 (< 5초)
- [x] 의존성 자동 복구
- [x] 환경 변수 초기화
- [x] 상세 로깅

### **테스트 (다음)**
- [ ] 정상 프로세스 모니터링
- [ ] 강제 종료 후 자동 복구 테스트
- [ ] 의존성 누락 시 자동 설치 테스트
- [ ] 메모리/CPU 사용량 추적 테스트

### **다음 단계 (Week 2)**
- [ ] 성능 최적화 (응답 시간 -50%)
- [ ] 토큰 효율 개선 (-30%)
- [ ] 메모리 누수 방지

---

## 🎯 **성공 기준**

```
안정성: 3/10 → 7/10

✅ 다운타임: 거의 없음 (< 1회/일)
✅ 자동 복구: 100% 성공 (< 5초)
✅ 로깅: 완벽 추적 (모든 이벤트 기록)
✅ 의존성: 자동 해결 (100%)
```

---

## 🧬 **신경생물학적 의미**

### **뇌간 (Brainstem)**
인간 뇌의 가장 기본적인 부분으로, 호흡, 심박수, 반사 등 생존에 필수적인 기능 담당.

### **아드레날린 (Adrenaline)**
위험 상황에서 신체를 빠르게 반응하도록 만드는 신경전달물질.

### **Watchdog의 역할**
- 뇌간: 봇의 생존 기능 (프로세스 실행)
- 아드레날린: 문제 감지 시 즉시 대응
- 재시작: 생명 유지 (프로세스 복구)

---

## 📞 **트러블슈팅**

### **Q: Watchdog이 시작 안 됨**
A: 환경 변수 확인
```bash
echo $TELEGRAM_BOT_TOKEN
# 비어있으면 설정 필요
export TELEGRAM_BOT_TOKEN="your_token"
```

### **Q: 프로세스가 계속 다운됨**
A: 로그 파일 확인
```bash
tail -f logs/watchdog/$(date +%Y%m%d)_watchdog.log
```

### **Q: 의존성 설치 실패**
A: 수동 설치
```bash
pip install python-telegram-bot aiohttp pillow requests pandas
```

---

**Week 1 Watchdog 구현 완료!** 🧠✨

다음: Week 2 성능 최적화
